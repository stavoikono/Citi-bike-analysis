---
title: "Citi Bike Analysis"
author: "Stavros Oikonomou"
date: "16/2/2020"
output: pdf_document
---

#### Analysis of citi bike database for May of 2016 at New Jersey and how the weather affectes 
#### the usage of bikes

### Data:
The site for the dataset can be found at [Citi Bike Dataset](https://www.citibikenyc.com/system-data)

This is the exact [Dataset](https://s3.amazonaws.com/tripdata/JC-201605-citibike-tripdata.csv.zip) i used for my analysis


### The data includes:
* Trip Duration (seconds)
* Start Time and Date
* Stop Time and Date
* Start Station Name
* End Station Name
* Station ID
* Station Lat/Long
* Bike ID
* User Type (Customer = 24-hour pass or 3-day pass user; Subscriber = Annual Member)
* Gender (Zero=unknown; 1=male; 2=female)
* Year of Birth

### Data notes:
* Trip count and milage estimates include trips with a duration of greater than one minute.
* Milage estimates are calculated using an assumed speed of 7.456 miles per hour, up to two hours. Trips over two   hours max-out at 14.9 miles. Once you opt into Ride Insights, the Citi Bike app will use your phone's location    to record the route you take between your starting and ending Citi Bike station to give exact mileage.
* We only include trips that begin at publicly available stations (thereby excluding trips that originate at our    depots for rebalancing or maintenance purposes).

### Weather Database:
I download from [Kaggle](https://www.kaggle.com/selfishgene/historical-hourly-weather-data) the temperature.csv, weather_description.csv and wind_speed.csv. I bind them and pick the May of 2016 to make my final weather.csv which i'm gonna use for my analysis. Also i change the temperature from kelvin to Celsius. 




### Loading the libraries
```{r libraries,warning=FALSE,message=FALSE}
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE,repos = 'http://cran.us.r-project.org')
  sapply(pkg, require, character.only = TRUE)
}

packages <- c("dplyr","data.table","ggplot2","tidyr", "MLDataR","tidymodels",
              "skimr","themis","stacks","lubridate","knitr","GGally","naniar",
              "lubridate","ggmap","randomForest","RColorBrewer","janitor","forcats",
              "leaflet", "leaflet.extras","plotly")

ipak(packages)
```


### downloading 
```{r, eval=F}
temp <- tempfile()
download.file("https://s3.amazonaws.com/tripdata/JC-201605-citibike-tripdata.csv.zip",temp, mode="wb")
unzip(temp, "JC-201605-citibike-tripdata.csv")
unlink(temp)

```


#### Loading the datasets
```{r weather , echo=T}
tempr <- fread("data/temperature.csv",stringsAsFactors = T, 
               header = T, select = c("datetime","New York"))

descr <- fread("data/weather_description.csv",stringsAsFactors = T, 
               header = T, select = c("datetime","New York"))

wind <- fread("data/wind_speed.csv",stringsAsFactors = T, 
               header = T, select = c("datetime","New York"))


weather <- tempr %>% dplyr::rename("temperature"="New York") %>%
  filter(grepl("2016-05",datetime)) %>%
  left_join(descr, by="datetime") %>% dplyr::rename("description"="New York") %>%
  left_join(wind, by="datetime") %>% dplyr::rename("wind"="New York") %>%
  mutate(temperature = temperature - 273.15)

rm(tempr,descr,wind)
```

```{r}
data <- fread("JC-201605-citibike-tripdata.csv", sep = ',',
                 stringsAsFactors = TRUE, header = TRUE, na.strings =c(""," ")) %>%
  janitor::clean_names()
```

## Data Preprocessing



### Data Structure and dimension

```{r}
str(data)
```

```{r}
data <- data %>% 
  mutate(bike_id = factor(as.character(bike_id)),
         gender = factor(case_when(gender==1 ~ "Male",
                            gender==2 ~ "Female",
                            TRUE ~ "Unknown")),
         age = 2016 - birth_year) %>%
  select(-birth_year,-start_station_id,-end_station_id) %>%
  filter(!is.na(user_type))
```

```{r}
skim(data)
```


```{r}
data %>% filter(trip_duration<3600) %>%
  ggplot(aes(x=trip_duration)) + geom_density(fill=I("red"), alpha=0.4) + theme_classic() +
  xlab("Trip Duration")

data <- data %>% filter(trip_duration<3600)
```

```{r}
data_old <- copy(data)
vars <-c("age","start_time","stop_time","start_station_name",
         "end_station_name","user_type")

rec <- recipe(formula = ~ .,
              data = data) %>%
  step_impute_knn(all_of(vars)) %>% prep()

data <- juice(rec)

data <- data %>% 
    mutate(age_groups = cut(age, breaks= c(-Inf,20,40,60,Inf), labels=c("0-20","20-40","40-60","60+")))
```


## Exploratory Data Analysis


```{r, warning=FALSE, message=FALSE}
data %>%
  select(trip_duration,age,gender, user_type) %>%
  ggpairs(aes(colour = user_type, alpha = 0.7))

```
As we can see we don't have information about the gender for the Customers.

```{r}
ggplot(data, aes(x=trip_duration, fill=age_groups)) + geom_density(alpha=0.7) +
  scale_x_log10() + facet_grid(user_type~age_groups) + scale_fill_viridis_d(option="C") +
  theme_bw()
```



#### Popular Start and End stations
```{r}
data %>% count(start_station_name,sort = T) %>% top_n(5) %>%
  ggplot(aes(x=fct_reorder(start_station_name,n), y=n)) +
  geom_col(aes(fill=start_station_name))+ coord_flip() + theme(legend.position = "none") + 
  labs(title = "Most Frequent Start Stations", y = "Frequency", x = "Stations") +
  geom_text(aes(label= n), size = 3, position = position_stack(vjust = 0.5))

data %>% count(end_station_name,sort = T) %>% top_n(5) %>%
  ggplot(aes(x=fct_reorder(end_station_name,n), y=n)) +
  geom_col(aes(fill=end_station_name))+ coord_flip() + theme(legend.position = "none") + 
  labs(title = "Most Frequent End Stations", y = "Frequency", x = "Stations") +
  geom_text(aes(label= n), size = 3, position = position_stack(vjust = 0.5))
``` 
 
#### Most popular destination from every station
```{r}
data %>% group_by(start_station_name, end_station_name) %>%
  dplyr::summarise(N=n()) %>%
  arrange(desc(N)) %>%
  ungroup() %>% 
  group_by(start_station_name) %>%
  mutate(N_start=sum(N)) %>%
  mutate(percentage=round(N/N_start,2)*100) %>%
  setNames(c("Start Station Name", "End Station Name", "Number of routes",
             "Count of entries Start Station",  "% Percentage")) %>% kable()

```
 



#### As we can see the Subscibers (annual membership) are more than Customers (24 hour or 3-day pass) but the Customers use the bikes for longer duration
 
 
#### Number of Gender per type and mean trip duration per Gender. As we can see the users who dont declare the sex use bikes for longer duration

 
#### Most users are between 20 and 40 and also the users who dont declare the sex are between 30 and 35.


#### Most popular Bikes
```{r}
data %>% count(bike_id, sort = T) %>% ggplot(aes(x=n)) + geom_density(fill=I("lightblue")) +
  xlab("Number of usage for each Bike") + ggtitle("Distribution of Bike usage") +
  theme_bw()

```
 
#### We can see that the trips during the weekdays are more than weekend but also sorter. It seems logical because as we can assume that the purpose of usage at weekdays is more about going to work or different kind of business. On the contrary we can assume tha the purpose of weekend usage is more about fun puproses while the user have not the pressure of time. Also subscribers use bikes more often at the weekday and customers more often at the weekend.
```{r}
data <- data %>% 
  mutate(day=wday(start_time, label=TRUE, abbr=FALSE, 
         week_start = getOption("lubridate.week.start", 7), 
         locale = "English_United States")) %>%
  mutate(hour=as.factor(hour(start_time)))

ggplotly(ggplot(data, aes(x=day,fill=day))+geom_bar() + 
  labs(title = "Number of trips per day"))

ggplotly(ggplot(data, aes(x=day, y=trip_duration, fill=day)) + 
  stat_summary(fun.y="mean", geom="bar") + 
  labs(title = "Mean Trip Duration per Day", y="Duration in seconds") + theme_bw())

ggplotly(ggplot(data, aes(x=day,fill=user_type))+geom_bar() + 
  labs(title = "Number of trips per day") + facet_grid(user_type ~ .))
```
 
### Rush hour graph
#### We can assume that the most subscribers use the bike as mean of transport to go or leave from work this is why we have so many entries around 8 am and 18 pm. Usually customers rent a bike for 24 hours so its seems reasonable to assume that most of them are tourists and using them to move around to see the sights of New Jersey.
```{r}
ggplotly(
  ggplot(data, aes(x=hour, fill=hour)) +geom_bar() + 
  labs(title = "Rush Hour", x="Hour") + 
  facet_grid(user_type ~ .) +
  theme(legend.position = "none") + theme_bw()
  )

```
 
### Heatmap of Start stations and top five Start Station position
```{r}
map_data <- bind_rows(data %>% select(lat=start_station_latitude, 
                            long=start_station_longitude,
                            name=start_station_name) %>%
            group_by(lat) %>%
            mutate(N=n()) %>%
            distinct() %>%
            mutate(popup = paste(sep = "<br/>",paste("<center>",name,"</center>"),
                                 paste("<center>",N,"</center>"))) %>%
            mutate(position="start"),
          data %>% select(lat=end_station_latitude, 
                                long=end_station_longitude,
                                name=end_station_name) %>%
            group_by(lat) %>%
            mutate(N=n()) %>%
            distinct() %>%
            mutate(popup = paste(sep = "<br/>",paste0("<center>",name,"</center>"),
                                 paste0("<center>",N,"</center>"))) %>%
            mutate(position="end")
)
```



```{r}
leaflet(map_data) %>%
  addTiles() %>%
  addMarkers(data= map_data %>% filter(position=="start"), popup = ~popup,
             lng = ~long, lat=~lat, group="Start") %>%
  addMarkers(data= map_data %>% filter(position=="end"), popup = ~popup,
             lng = ~long, lat=~lat, group = "End") %>%
  addHeatmap(data= map_data %>% filter(position=="start"),
             lng=~long,lat=~lat,intensity=~sqrt(N),max = ~max(sqrt(N)),
             radius = 60, blur = 100,
             layerId = "Start", group = "Start") %>%
  addCircleMarkers(data= map_data %>% filter(position=="start"),
                   lng = ~long, lat=~lat, radius = ~sqrt(N),
                   fillOpacity = 0.1, opacity = 0.1, color = "red") %>%
  addHeatmap(data= map_data %>% filter(position=="end"),
             lng=~long,lat=~lat,intensity=~sqrt(N),max = ~max(sqrt(N)),
             radius = 60, blur = 100,
             layerId = "End", group = "End") %>%
  addCircleMarkers(data= map_data %>% filter(position=="end"),
                   lng = ~long, lat=~lat, radius = ~sqrt(N),
                   fillOpacity = 0.1, opacity = 0.1, color = "red") %>%
  addLayersControl(
    baseGroups = c("Start","End"),
    options = layersControlOptions(collapsed = FALSE)
  )
```


```{r}
library(osrm)
getOption("osrm.server")

start_point_df <- data_map_start %>%
  select(id=name, lon=long, lat) %>%
  as.data.frame()

end_point_df <- data_map_end %>%
  select(id=name, lon=long, lat) %>%
  as.data.frame()

distancetable <- osrmTable(src = start_point_df, dst = end_point_df,
                           measure = c("duration","distance"),osrm.profile = "bike")

osrm_duration <- distancetable$durations %>% as.data.frame() %>%
  mutate(start_station_name=row.names(.)) %>%
  pivot_longer(!start_station_name, names_to = "end_station_name", values_to = "duration") %>%
  filter(duration > 0)


osrm_distance <- distancetable$distances %>% as.data.frame() %>%
  mutate(start_station_name=row.names(.)) %>%
  pivot_longer(!start_station_name, names_to = "end_station_name", values_to = "distance") %>%
  filter(distance > 0) %>%
  mutate(distance=distance/1000)
```

```{r}
test_start <- start_point_df[1:2,]

test_end <- end_point_df[5:6,]

route <- osrmRoute(c(-74.04425,40.72760), c(-74.04312,40.71959), overview = 'full')

leaflet() %>% addTiles() %>%
  addMarkers(c(-74.04312,-74.04425), c(40.71959,40.72760)) %>%
  addPolylines(route$lon,route$lat)
  
```


```{r,warning=FALSE,message=FALSE, include=FALSE, eval=FALSE}

chi_bb <- c(left = min(data$start_station_longitude),
            bottom = min(data$start_station_latitude),
            right = max(data$start_station_longitude),
            top = max(data$start_station_latitude))

JC_stamen <- get_stamenmap(bbox = chi_bb, zoom=13)

pointstolabel <- c("Grove St PATH", "Exchange Place", "Sip Ave", "Hamilton Park", "Newport PATH")

ggmap(JC_stamen) +
  stat_density_2d(data = data,
              mapping = aes(x = Start.Station.Longitude,
              y = Start.Station.Latitude,fill = stat(level)),
              alpha = .2,
              bins = 50,
              geom = "polygon") + scale_fill_gradientn(colors = brewer.pal(7, "YlOrRd")) +
  geom_point(data = data, color=I("red"), 
             mapping = aes(x = Start.Station.Longitude,
             y = Start.Station.Latitude)) + 
  geom_text(data=subset(data, Start.Station.Name %in% pointstolabel), 
            aes(x= Start.Station.Longitude, y = Start.Station.Latitude, 
            label = Start.Station.Name, color=I("Grey20"))) + 
  theme(legend.position = "none") + 
  labs(title = "Heatmap of Start Station Popularity", y = "Latitude", x = "Longitude")

ggmap(JC_stamen) +
  stat_density_2d(data = data,
                  mapping = aes(x = End.Station.Longitude,
                  y = End.Station.Latitude,fill = stat(level)),
                  alpha = .2,
                  bins = 50,
                  geom = "polygon") + scale_fill_gradientn(colors = brewer.pal(7, "YlOrRd")) +
  geom_point(data = data, color=I("red"), 
            mapping = aes(x = End.Station.Longitude,
            y = End.Station.Latitude)) + 
  geom_text(data=subset(data, End.Station.Name %in% pointstolabel), 
            aes(x= End.Station.Longitude, y = End.Station.Latitude, 
            label = End.Station.Name, color=I("Grey20"))) + 
  theme(legend.position = "none") + 
  labs(title = "Heatmap of End Station Popularity", y = "Latitude", x = "Longitude")

```


```{r}
chi_bb <- c(left = min(data$start_station_longitude),
            bottom = min(data$start_station_latitude),
            right = max(data$start_station_longitude),
            top = max(data$start_station_latitude))

maps <- get_map(chi_bb, maptype='terrain', source='stamen', zoom=13)

trips <- data %>%
  group_by(start_station_longitude,
           start_station_latitude,
           end_station_longitude,
           end_station_latitude,
           start_station_name,
           end_station_name) %>%
  summarize(rides = n())


ggmap(maps,darken = c(.8,"#FFFFFF")) + 
  geom_segment(data = trips,
               aes(x = start_station_longitude, 
                   y = start_station_latitude,
                   xend = end_station_longitude,
                   yend = end_station_latitude,
                   alpha = sqrt(rides)),
               color = "#000000") + coord_map() + 
  scale_alpha(range = c(0.0001, .5)) +
  geom_point(data = trips %>% 
               group_by(longitude = start_station_longitude,
                        latitude = start_station_latitude) %>%
               summarize(rides = sum(rides)),
             aes(x = longitude, 
                 y = latitude,
                 size = rides),
             color="#009900",alpha=.4) + 
  scale_size_continuous(range(4,100)) +
  scale_color_viridis_c() + 
  scale_fill_viridis_c() + 
  theme_nothing()
```


 
 
### Joining data and weather dataset

#### Creating common column for joining purposes.
```{r}
data_weather <- data %>%
  mutate(datetime=round_date(ymd_hms(start_time),"hour")) %>%
  left_join(weather)
```
 
#### description engineering
```{r}

data_weather <- data_weather %>%
  mutate(description=
           case_when(description %in% c("thunderstorm with light rain",
                                        "thunderstorm","proximity thunderstorm") ~ "Thunderstorm",
                     description %in% c("drizzle","light intensity drizzle",
                                           "moderate rain","light rain") ~ "Rainy",
                     description %in% c("broken clouds","few clouds","overcast clouds",
                                           "scattered clouds") ~ "Cloudy",
                     description %in% c("fog","haze","mist") ~ "Mist",
                     description=="sky is clear" ~ "Clear",
                     TRUE ~ NA_character_)) %>%
  mutate(description=factor(description)) %>%
  mutate(temp = round(temperature,0)) %>%
  mutate(wind=factor(wind))

```

###  Impact of weather on the trip duration


#### We can see that the most routes start with cloudy or misty weather and it seem logical because is usual to have mist around 7-9 am and because we are at May the weather can not be so clear or having thunderstorms.
```{r}
ggplot(data_weather, aes(x=description))+ geom_bar(aes(fill=description)) + labs(title = "Number of routes per weather condition")

ggplot(data_weather, aes(x=hour(data_weather$start_time),fill=description))+geom_bar() + 
  labs(title = "Rush Hour", x="Hour")
```



#### We can see that the weather conditions does not have so much impact at trip duration.
```{r}
boxplot(trip_duration ~ description, data= data_weather, col = "orange", main = "Impact of weather on trip duration",  xlab = "Weather conditions", ylab = "Trip Duration")
```
 
 
#### If the wind is more than 5 there are not so many bike users, but the wind's impact is not so big regarding to the mean trip duration.
```{r}
data_weather$wind <- factor(data_weather$wind)
ggplot(data_weather, aes(x=wind))+ geom_bar(aes(fill=wind)) + labs(title = "Number of routes per wind condition") + theme(legend.position = "none")
boxplot(trip_duration~wind, data= data_weather, col = "blue", main = "Impact of wind on trip duration",  xlab = "Wind", ylab = "Trip Duration")
```
 
 
#### The temperature has impact on trip duration
```{r}
ggplot(data_weather, aes(x=temp))+ geom_bar(aes(fill=as.factor(temp))) + labs(title = "Number of routes per temperature") + theme(legend.position = "none")
ggplot(data_weather, aes(x=temp,y=trip_duration)) + 
  stat_summary(fun.y="mean", geom="line", color="red",size=1) + 
  labs(title = "Mean Trip Duration per Temperature", y="mean Trip Duration") + geom_smooth()

```
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
         
